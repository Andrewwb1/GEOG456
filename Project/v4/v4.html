<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking US State-level Immigrant Populations Over Time</title>
</head>
<style>
  .map-container {
    display: grid;
    grid-template-columns: repeat(12, 80px);
    grid-auto-rows: 80px;
    gap: 5px;
    justify-content: center;
    margin: 30px auto;
    width: max-content; 
  }

  .state-tile {
    width: 80px;
    height: 80px;
    background: #ddd;
    border: 1px solid #aaa;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    position: relative;
  }

  .state-tile:hover {
    background-color: #bbb;
  }

  .detail-box {
    width: 400px;        
    height: 500px;       
    border: 1px solid #888;
    margin-left: 20px;
    padding: 15px;
    float: left;
    background-color: white;
    overflow: visible;
  }

  .detail-header {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
    text-align: center;
  }
  
  /* Modified slider container to center within larger box */
  .slider-container {
    width: 350px;
    margin: 20px auto;
  }
  
  #year-slider {
    width: 100%;
  }
  
  #year-label {
    text-align: center;
    font-size: 18px;
    margin: 10px 0;
  }
  
  /* Modified pie chart container to use full width */
  .pie-chart-container {
    width: 4-0px;
    height: 400px;
    margin: 0 auto;
    overflow: visible;
  }
  
  .main-container {
    display: flex;
    justify-content: center;
  }
  
  /* Pie chart colors */
  .slice {
    stroke: #fff;
    stroke-width: 1px;
  }
  
  .legend {
    font-size: 12px;
  }
</style>
<body>
    <h1>Tracking US State-level Immigrant Populations Over Time</h1>
    Author: Andrew Boettcher <br><br>


    <!-- <script src="Data/data.js"></script>
    <script src="Data/simple_data.js"></script> -->
<!-- I will change the classes to ID -->
    <div class="main-container">
      <div class="map-container">
        <!-- Row 1 -->
        <div id="Alaska" class="state-tile" style="grid-column: 1; grid-row: 1;">AK</div>
        <div id="Maine" class="state-tile" style="grid-column: 12; grid-row: 1;">ME</div>
      
        <!-- Row 2 -->
        <div id="Vermont" class="state-tile" style="grid-column: 11; grid-row: 2;">VT</div>
        <div id="New Hampshire" class="state-tile" style="grid-column: 12; grid-row: 2;">NH</div>
      
        <!-- Row 3 -->
        <div id="Washington" class="state-tile" style="grid-column: 2; grid-row: 3;">WA</div>
        <div id="Idaho" class="state-tile" style="grid-column: 3; grid-row: 3;">ID</div>
        <div id="Montana" class="state-tile" style="grid-column: 4; grid-row: 3;">MT</div>
        <div id="North Dakota" class="state-tile" style="grid-column: 5; grid-row: 3;">ND</div>
        <div id="Minnesota" class="state-tile" style="grid-column: 6; grid-row: 3;">MN</div>
        <div id="Illinois" class="state-tile" style="grid-column: 7; grid-row: 3;">IL</div>
        <div id="Wisconsin" class="state-tile" style="grid-column: 8; grid-row: 3;">WI</div>
        <div id="Michigan" class="state-tile" style="grid-column: 9; grid-row: 3;">MI</div>
        <div id="New York" class="state-tile" style="grid-column: 10; grid-row: 3;">NY</div>
        <div id="Rhode Island" class="state-tile" style="grid-column: 11; grid-row: 3;">RI</div>
        <div id="Massachusetts" class="state-tile" style="grid-column: 12; grid-row: 3;">MA</div>
      
        <!-- Row 4 -->
        <div id="Oregon" class="state-tile" style="grid-column: 2; grid-row: 4;">OR</div>
        <div id="Nevada" class="state-tile" style="grid-column: 3; grid-row: 4;">NV</div>
        <div id="Wyoming" class="state-tile" style="grid-column: 4; grid-row: 4;">WY</div>
        <div id="South Dakota" class="state-tile" style="grid-column: 5; grid-row: 4;">SD</div>
        <div id="Iowa" class="state-tile" style="grid-column: 6; grid-row: 4;">IA</div>
        <div id="Indiana" class="state-tile" style="grid-column: 7; grid-row: 4;">IN</div>
        <div id="Ohio" class="state-tile" style="grid-column: 8; grid-row: 4;">OH</div>
        <div id="Pennsylvania" class="state-tile" style="grid-column: 9; grid-row: 4;">PA</div>
        <div id="New Jersey" class="state-tile" style="grid-column: 10; grid-row: 4;">NJ</div>
        <div id="Connecticut" class="state-tile" style="grid-column: 11; grid-row: 4;">CT</div>
      
        <!-- Row 5 -->
        <div id="California" class="state-tile" style="grid-column: 2; grid-row: 5;">CA</div>
        <div id="Utah" class="state-tile" style="grid-column: 3; grid-row: 5;">UT</div>
        <div id="Colorado" class="state-tile" style="grid-column: 4; grid-row: 5;">CO</div>
        <div id="Nebraska" class="state-tile" style="grid-column: 5; grid-row: 5;">NE</div>
        <div id="Missouri" class="state-tile" style="grid-column: 6; grid-row: 5;">MO</div>
        <div id="Kentucky" class="state-tile" style="grid-column: 7; grid-row: 5;">KY</div>
        <div id="West Virginia" class="state-tile" style="grid-column: 8; grid-row: 5;">WV</div>
        <div id="Virginia" class="state-tile" style="grid-column: 9; grid-row: 5;">VA</div>
        <div id="Maryland" class="state-tile" style="grid-column: 10; grid-row: 5;">MD</div>
        <div id="Delaware" class="state-tile" style="grid-column: 11; grid-row: 5;">DE</div>
      
        <!-- Row 6 -->
        <div id="Arizona" class="state-tile" style="grid-column: 3; grid-row: 6;">AZ</div>
        <div id="New Mexico" class="state-tile" style="grid-column: 4; grid-row: 6;">NM</div>
        <div id="Kansas" class="state-tile" style="grid-column: 5; grid-row: 6;">KS</div>
        <div id="Arkansas" class="state-tile" style="grid-column: 6; grid-row: 6;">AR</div>
        <div id="Tennessee" class="state-tile" style="grid-column: 7; grid-row: 6;">TN</div>
        <div id="North Carolina" class="state-tile" style="grid-column: 8; grid-row: 6;">NC</div>
        <div id="South Carolina" class="state-tile" style="grid-column: 9; grid-row: 6;">SC</div>
        <div id="District of Columbia" class="state-tile" style="grid-column: 10; grid-row: 6;">DC</div>
      
        <!-- Row 7 -->
        <div id="Oklahoma" class="state-tile" style="grid-column: 5; grid-row: 7;">OK</div>
        <div id="Louisiana" class="state-tile" style="grid-column: 6; grid-row: 7;">LA</div>
        <div id="Mississippi" class="state-tile" style="grid-column: 7; grid-row: 7;">MS</div>
        <div id="Alabama" class="state-tile" style="grid-column: 8; grid-row: 7;">AL</div>
        <div id="Georgia" class="state-tile" style="grid-column: 9; grid-row: 7;">GA</div>
      
        <!-- Row 8 -->
        <div id="Hawaii" class="state-tile" style="grid-column: 1; grid-row: 8;">HI</div>
        <div id="Texas" class="state-tile" style="grid-column: 5; grid-row: 8;">TX</div>
        <div id="Florida" class="state-tile" style="grid-column: 10; grid-row: 8;">FL</div>
      </div>
      <div class="detail-box">
        <div class="detail-header">Select a state to view immigrant population details</div>
        <div class="pie-chart-container" id="pie-chart"></div>
        <div class="slider-container">
          <div id="year-label">Year: 1850</div>
          <input type="range" id="year-slider" min="0" max="16" value="0" step="1">
        </div>
      </div>

<script src="transformed_by_state_year_country.js"></script> 
<script>
//Code made with some help from ChatGPT
function makeGraph(data, stateName, allYears) {
  const container = document.getElementById(stateName);
  if (!container || !data[stateName]) return;

  container.innerHTML = '';

  const { width, height } = container.getBoundingClientRect();
  const padding = 0;

  const stateData = data[stateName];
  const xStep = (width - 2 * padding) / (allYears.length - 1);

  const nativePolygons = [];
  const nonNativePolygons = [];
  const solidLines = [];
  const dashedLines = [];

  let currentNative = [];
  let currentNonNative = [];
  let currentLine = [];
  let previousSegmentEnd = null;

  allYears.forEach((year, i) => {
    const yearStr = String(year);
    const x = padding + i * xStep;

    if (stateData[yearStr]) {
      const yearData = stateData[yearStr];
      const total = Object.values(yearData).reduce((sum, val) => sum + val, 0);
      const native = yearData["Native Born"] || 0;
      const percent = total > 0 ? (native / total) * 100 : 0;

      const yNative = height - (percent / 100) * height;
      const yBottom = height;
      const yTop = 0;

      const point = [x, yNative];

     //via dashed line connections
      if (currentLine.length === 0 && previousSegmentEnd) {
        dashedLines.push([previousSegmentEnd, point]);
      }

      currentNative.push(point);
      currentNonNative.push([x, yNative, x, yTop]);
      currentLine.push(point);
    } else {
      // gap in the data
      if (currentNative.length > 0) {
        const nativePoints = [
          ...currentNative.map(p => `${p[0]},${p[1]}`),
          ...currentNative.slice().reverse().map(p => `${p[0]},${height}`)
        ].join(' ');
        nativePolygons.push(nativePoints);
        previousSegmentEnd = currentNative[currentNative.length - 1]; // store last point
        currentNative = [];
      }

      if (currentNonNative.length > 0) {
        const nonNativePoints = [];
        for (let j = 0; j < currentNonNative.length; j++) {
          nonNativePoints.push(`${currentNonNative[j][0]},${currentNonNative[j][1]}`);
        }
        for (let j = currentNonNative.length - 1; j >= 0; j--) {
          nonNativePoints.push(`${currentNonNative[j][2]},${currentNonNative[j][3]}`);
        }
        nonNativePolygons.push(nonNativePoints.join(' '));
        currentNonNative = [];
      }

      if (currentLine.length > 0) {
        solidLines.push([...currentLine]);
        currentLine = [];
      }
    }
  });

  // remove last segment
  if (currentNative.length > 0) {
    const nativePoints = [
      ...currentNative.map(p => `${p[0]},${p[1]}`),
      ...currentNative.slice().reverse().map(p => `${p[0]},${height}`)
    ].join(' ');
    nativePolygons.push(nativePoints);
  }

  if (currentNonNative.length > 0) {
    const nonNativePoints = [];
    for (let j = 0; j < currentNonNative.length; j++) {
      nonNativePoints.push(`${currentNonNative[j][0]},${currentNonNative[j][1]}`);
    }
    for (let j = currentNonNative.length - 1; j >= 0; j--) {
      nonNativePoints.push(`${currentNonNative[j][2]},${currentNonNative[j][3]}`);
    }
    nonNativePolygons.push(nonNativePoints.join(' '));
  }

  if (currentLine.length > 0) {
    solidLines.push([...currentLine]);
  }

  // making the SVG 
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("width", width);
  svg.setAttribute("height", height);
  svg.style.background = "#b6bcc2";

  nonNativePolygons.forEach(points => {
    const poly = document.createElementNS(svgNS, "polygon");
    poly.setAttribute("points", points);
    poly.setAttribute("fill", "#e34724");
    svg.appendChild(poly);
  });

  nativePolygons.forEach(points => {
    const poly = document.createElementNS(svgNS, "polygon");
    poly.setAttribute("points", points);
    poly.setAttribute("fill", "#3488d1");
    svg.appendChild(poly);
  });

  solidLines.forEach(line => {
    const path = document.createElementNS(svgNS, "polyline");
    path.setAttribute("points", line.map(p => `${p[0]},${p[1]}`).join(' '));
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", "black");
    path.setAttribute("stroke-width", "1");
    svg.appendChild(path);
  });

  dashedLines.forEach(([p1, p2]) => {
    const line = document.createElementNS(svgNS, "line");
    line.setAttribute("x1", p1[0]);
    line.setAttribute("y1", p1[1]);
    line.setAttribute("x2", p2[0]);
    line.setAttribute("y2", p2[1]);
    line.setAttribute("stroke", "black");
    line.setAttribute("stroke-width", "1");
    line.setAttribute("stroke-dasharray", "4,2");
    svg.appendChild(line);
  });

  // Get state initials - extract them from the state names
  let stateInitials;
  if (stateName === "District of Columbia") {
    stateInitials = "DC";
  } else {
  // had to add state abbreviations since no longer in the data
    const stateAbbreviations = {
    "Alabama": "AL", "Alaska": "AK", "Arizona": "AZ", "Arkansas": "AR", 
    "California": "CA", "Colorado": "CO", "Connecticut": "CT", "Delaware": "DE",
    "Florida": "FL", "Georgia": "GA", "Hawaii": "HI", "Idaho": "ID",
    "Illinois": "IL", "Indiana": "IN", "Iowa": "IA", "Kansas": "KS",
    "Kentucky": "KY", "Louisiana": "LA", "Maine": "ME", "Maryland": "MD",
    "Massachusetts": "MA", "Michigan": "MI", "Minnesota": "MN", "Mississippi": "MS",
    "Missouri": "MO", "Montana": "MT", "Nebraska": "NE", "Nevada": "NV",
    "New Hampshire": "NH", "New Jersey": "NJ", "New Mexico": "NM", "New York": "NY",
    "North Carolina": "NC", "North Dakota": "ND", "Ohio": "OH", "Oklahoma": "OK",
    "Oregon": "OR", "Pennsylvania": "PA", "Rhode Island": "RI", "South Carolina": "SC",
    "South Dakota": "SD", "Tennessee": "TN", "Texas": "TX", "Utah": "UT",
    "Vermont": "VT", "Virginia": "VA", "Washington": "WA", "West Virginia": "WV",
    "Wisconsin": "WI", "Wyoming": "WY"
    };
  
  stateInitials = stateAbbreviations[stateName] || stateName.substring(0, 2);
}
  
  // Add state initials text in top-right corner
  const stateText = document.createElementNS(svgNS, "text");
  stateText.setAttribute("x", width - 4); // 5px from right edge
  stateText.setAttribute("y", height - 7); // move to bottom and allow variable by layout
  stateText.setAttribute("font-family", "Arial, sans-serif");
  stateText.setAttribute("font-size", "12px");
  stateText.setAttribute("font-weight", "bold");
  stateText.setAttribute("text-anchor", "end"); // Right-align text
  stateText.setAttribute("fill", "black");
  stateText.textContent = stateInitials;
  
  svg.appendChild(stateText);
  container.appendChild(svg);



  // Add click event listener for this state tile
  container.addEventListener('click', () => {
    updateDetailBox(stateName, allYears[0]); // Default to first year (1850)
    document.getElementById('year-slider').value = 0; // Reset slider to beginning
    document.getElementById('year-label').textContent = `Year: ${allYears[0]}`;
    
    // Update current state in memory
    currentState = stateName;
    
    // Update header
    document.querySelector('.detail-header').textContent = `${stateName} - Immigrant Population`;
  });
}

function createPieChart(stateName, year) {
  const pieChartContainer = document.getElementById('pie-chart');
  pieChartContainer.innerHTML = '';
  
  // Debug info
  console.log(`Creating pie chart for ${stateName}, ${year}`);
  
  // Get the data for this state and year
  if (!data[stateName] || !data[stateName][year]) {
    pieChartContainer.innerHTML = '<div style="text-align:center; padding-top:120px;">No immigrant data available for this year</div>';
    return;
  }
  
  const stateYearData = data[stateName][year];
  console.log("Data found:", stateYearData);
  
  // Filter out native born and prepare data for pie chart
  const immigrantData = {};
  for (const [country, value] of Object.entries(stateYearData)) {
    if (country !== "Native Born" && value > 0) {
      immigrantData[country] = value;
    }
  }
  
  // If no immigrant data
  if (Object.keys(immigrantData).length === 0) {
    pieChartContainer.innerHTML = '<div style="text-align:center; padding-top:120px;">No immigrant data available for this year</div>';
    return;
  }
  
  // Sort countries by population count
  const sortedCountries = Object.entries(immigrantData)
    .sort((a, b) => b[1] - a[1]);
  
  // Prepare data with top 10 and "Other"
  let pieData = [];
  let otherTotal = 0;
  
  if (sortedCountries.length <= 10) {
    pieData = sortedCountries;
  } else {
    pieData = sortedCountries.slice(0, 10);
    for (let i = 10; i < sortedCountries.length; i++) {
      otherTotal += sortedCountries[i][1];
    }
    if (otherTotal > 0) {
      pieData.push(["Other", otherTotal]);
    }
  }
  
  console.log("Pie data prepared:", pieData);
  
  // Calculate total for percentages
  const total = pieData.reduce((sum, item) => sum + item[1], 0);
  
  // Create SVG for pie chart - UPDATED to fill container
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.setAttribute("viewBox", "0 0 400 400");
  svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
  svg.style.display = "block";
  
  // Add title
  const title = document.createElementNS(svgNS, "text");
  title.setAttribute("x", "200");
  title.setAttribute("y", "25");
  title.setAttribute("text-anchor", "middle");
  title.setAttribute("font-weight", "bold");
  title.setAttribute("font-size", "16px");
  title.textContent = `Foreign-Born Population - ${year}`;
  svg.appendChild(title);
  
  // Generate colors with an extra color for "Other"
  const colors = [
    "#4e79a7", "#f28e2c", "#e15759", "#76b7b2", "#59a14f",
    "#edc949", "#af7aa1", "#ff9da7", "#9c755f", "#bab0ab",
    "#8dd3c7" // Extra color for "Other" category
  ];
  
  // Draw pie slices - UPDATED with larger radius and centered
  const centerX = 200;
  const centerY = 180; // Adjusted center point
  const radius = 120; // Increased from 100 to 140
  let startAngle = 0;
  
  pieData.forEach((item, i) => {
    const [country, value] = item;
    const percentage = (value / total) * 100;
    const angle = (percentage / 100) * 2 * Math.PI;
    const endAngle = startAngle + angle;
    
    // Calculate arc points
    const x1 = centerX + radius * Math.cos(startAngle - Math.PI/2);
    const y1 = centerY + radius * Math.sin(startAngle - Math.PI/2);
    const x2 = centerX + radius * Math.cos(endAngle - Math.PI/2);
    const y2 = centerY + radius * Math.sin(endAngle - Math.PI/2);
    
    // Create pie slice
    const largeArcFlag = angle > Math.PI ? 1 : 0;
    const pathData = [
      `M ${centerX} ${centerY}`,
      `L ${x1} ${y1}`,
      `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
      'Z'
    ].join(' ');
    
    const path = document.createElementNS(svgNS, "path");
    path.setAttribute("d", pathData);
    path.setAttribute("fill", colors[i % colors.length]);
    path.setAttribute("stroke", "#fff");
    path.setAttribute("stroke-width", "1");
    svg.appendChild(path);
    
    // Add label - UPDATED for better positioning
    if (percentage > 5) {  // Only add labels for slices that are big enough
      const labelAngle = startAngle + angle/2;
      const labelRadius = radius * 0.7;
      const labelX = centerX + labelRadius * Math.cos(labelAngle - Math.PI/2);
      const labelY = centerY + labelRadius * Math.sin(labelAngle - Math.PI/2);
      
      const text = document.createElementNS(svgNS, "text");
      text.setAttribute("x", labelX);
      text.setAttribute("y", labelY);
      text.setAttribute("text-anchor", "middle");
      text.setAttribute("fill", "white");
      text.setAttribute("font-size", "12px"); // Slightly larger
      text.setAttribute("font-weight", "bold");
      text.textContent = `${percentage > 7 ? Math.round(percentage) + '%' : ''}`;
      svg.appendChild(text);
    }
    
    startAngle = endAngle;
  });
  
    // legend
  const legendY = 320; 
  const legendX = 60;
  const legendItemsPerRow = 2; 
  const itemWidth = 200; 
  
  pieData.forEach((item, i) => {
    const [country, value] = item;
    const percentage = (value / total) * 100;
    const row = Math.floor(i / legendItemsPerRow);
    const col = i % legendItemsPerRow;
    
    // Colored rectangle
    const rect = document.createElementNS(svgNS, "rect");
    rect.setAttribute("x", legendX + col * itemWidth);
    rect.setAttribute("y", legendY + row * 20);
    rect.setAttribute("width", "12"); // Slightly larger
    rect.setAttribute("height", "12");
    rect.setAttribute("fill", colors[i % colors.length]);
    svg.appendChild(rect);
    
    // Text label - no truncation needed with wider layout
    const text = document.createElementNS(svgNS, "text");
    text.setAttribute("x", legendX + 18 + col * itemWidth);
    text.setAttribute("y", legendY + 10 + row * 20);
    text.setAttribute("font-size", "11px");
    
    // No need to cut off country names with more space
    text.textContent = `${country} (${percentage.toFixed(1)}%)`;
    svg.appendChild(text);
  });
  
  // Append to container
  pieChartContainer.appendChild(svg);
}
// Variable to keep track of the currently selected state
let currentState = null;

// Function to update the detail box with data for a specific state and year
function updateDetailBox(stateName, year) {
  createPieChart(stateName, year);
}

// Set up slider event listener
document.getElementById('year-slider').addEventListener('input', function() {
  if (!currentState) return;
  
  const yearIndex = parseInt(this.value);
  const selectedYear = allYears[yearIndex];
  
  document.getElementById('year-label').textContent = `Year: ${selectedYear}`;
  updateDetailBox(currentState, selectedYear);
});
const allYears = [1850, 1860, 1870, 1880, 1900, 1910, 1920, 1930, 1940, 1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020];

// Testing some states that have missing data and that have all the years. 
// makeGraph(data, "Alaska", allYears);
// makeGraph(data, "New York", allYears);
// makeGraph(data, "Hawaii", allYears);

const stateNames = [
  "Alaska", "Maine", "Vermont", "New Hampshire", "Washington", "Idaho", "Montana",
  "North Dakota", "Minnesota", "Illinois", "Wisconsin", "Michigan", "New York",
  "Rhode Island", "Massachusetts", "Oregon", "Nevada", "Wyoming", "South Dakota",
  "Iowa", "Indiana", "Ohio", "Pennsylvania", "New Jersey", "Connecticut", "California",
  "Utah", "Colorado", "Nebraska", "Missouri", "Kentucky", "West Virginia", "Virginia",
  "Maryland", "Delaware", "Arizona", "New Mexico", "Kansas", "Arkansas", "Tennessee",
  "North Carolina", "South Carolina", "District of Columbia", "Oklahoma", "Louisiana",
  "Mississippi", "Alabama", "Georgia", "Hawaii", "Texas", "Florida"
];
// looping through the stateName array and running the makeGraph function
stateNames.forEach(state=> makeGraph(data,state,allYears))

setTimeout(() => {
  console.log("Clicking on New York", data["New York"]);// remove after debug
  document.getElementById('New York').click();
}, 500);

</script>
</body>
</html>